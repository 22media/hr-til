$(function(){

  // Taken from underscore.js
  function debounce(func, wait, immediate) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  };

  var post_body = {
    $el: $("#post_body"),
    renderMarkdown: function() {
      var txt = $("#post_body").val();
      $.post("/post_preview", {body: txt}, function(result){
        $(".content_preview").html(result);
      });
    },
    renderWordCount: function() {
      var max = <%= Post::MAX_WORDS %>
      var word_count = $("#post_body").val().split(/\s+|\n/).filter(Boolean).length;
      var result = max - word_count

      if(result < 0) {
        $(".word_count").addClass('negative');
      } else {
        $(".word_count").removeClass('negative');
      }

      var copy = result === 1 ? ' word available' : ' words available'
      $(".word_count").html(result + copy);
    },
    init: function() {
      this.$el.on('keyup', this.renderWordCount).each(this.renderWordCount);
      this.$el.on('keyup', debounce(this.renderMarkdown, 350)).each(this.renderMarkdown);
    }
  }

  post_body.init();

  // Twitter button
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');

});
