$(function(){
	// Taken from underscore.js
	function debounce(func, wait, immediate) {
		var timeout;
		return function() {
			var context = this, args = arguments;
			var later = function() {
				timeout = null;
				if (!immediate) func.apply(context, args);
			};
			var callNow = immediate && !timeout;
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
			if (callNow) func.apply(context, args);
		};
	};

	var renderMarkdown = function(){
		var txt = $("#post_body").val();
		$.post("/post_preview", {body: txt}, function(result){
			$(".content_preview").html(result);
		});
	};

	var renderWordCount = function(){
		var max = <%= Post::MAX_WORDS + 1 %>
		var words = $("#post_body").val().split(' ').length;
		var result = max - words

		if(result < 0) {
			$(".word_count").addClass('negative');
		} else {
			$(".word_count").removeClass('negative');
		}

		var copy = result === 1 ? ' word available' : ' words available'
		$(".word_count").html(result + copy);
	};

	$('#post_body').on('keyup', renderWordCount).each(renderWordCount);
	$('#post_body').on('keyup', debounce(renderMarkdown, 350)).each(renderMarkdown);

	// Twitter button
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
});
